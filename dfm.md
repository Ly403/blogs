# 离散型流匹配模型

本文是接着上一次学习的CTMC模型继续学习离散型流匹配模型，主要是读Flow Matching Guide and Code[^1](Lipman)第7章的笔记。并非完全Flow Matching Guide and Code的翻译，挑了一些重要的内容并且加入了我自己的的理解。

要构建一个离散型流匹配模型（Discrete Flow Matching，DFM），分为三个步骤：

1.  类比连续型FM，定义一个概率路径<img src="https://www.zhihu.com/equation?tex=p_t" alt="p_t" class="ee_img tr_noresize" eeimg="1">，连接原始分布的pmf和目标分布的pmf。pmf就是概率质量函数。
1.  构建一个CTMC模型，<img src="https://www.zhihu.com/equation?tex=%7B%28X_%7Bt%7D%29%7D_%7B0%20%5Cle%20t%20%5Cle%201%7D" alt="{(X_{t})}_{0 \le t \le 1}" class="ee_img tr_noresize" eeimg="1">，该CTMC的速度场<img src="https://www.zhihu.com/equation?tex=u_%7Bt%7D%5E%7B%5Ctheta%7D" alt="u_{t}^{\theta}" class="ee_img tr_noresize" eeimg="1">生成出第1步中的概率路径<img src="https://www.zhihu.com/equation?tex=p_t" alt="p_t" class="ee_img tr_noresize" eeimg="1">，<img src="https://www.zhihu.com/equation?tex=%5Ctheta" alt="\theta" class="ee_img tr_noresize" eeimg="1">是可学习的参数。
1.  训练<img src="https://www.zhihu.com/equation?tex=u_%7Bt%7D%5E%7B%5Ctheta%7D" alt="u_{t}^{\theta}" class="ee_img tr_noresize" eeimg="1">，使之最小化Bregman散度，Bregman散度就是DFM的损失函数。

后面我就把离散型流匹配模型简称为DFM，连续型流匹配模型简称为FM。

## 数据和数据的成对

像FM里面一样，定义源分布的pmf为<img src="https://www.zhihu.com/equation?tex=p" alt="p" class="ee_img tr_noresize" eeimg="1">，目标分布的pmf为<img src="https://www.zhihu.com/equation?tex=q" alt="q" class="ee_img tr_noresize" eeimg="1">。源分布的随机变量（Random Variable，RV）记为<img src="https://www.zhihu.com/equation?tex=X_0" alt="X_0" class="ee_img tr_noresize" eeimg="1">，目标分布的随机变量记为<img src="https://www.zhihu.com/equation?tex=X_1" alt="X_1" class="ee_img tr_noresize" eeimg="1">。<img src="https://www.zhihu.com/equation?tex=X_0%2CX_1%20%5Cin%20%5Cmathcal%7BS%7D" alt="X_0,X_1 \in \mathcal{S}" class="ee_img tr_noresize" eeimg="1">，<img src="https://www.zhihu.com/equation?tex=%5Cmathcal%7BS%7D" alt="\mathcal{S}" class="ee_img tr_noresize" eeimg="1">就是CTMC模型里面提到的状态空间。

考虑到我们一般把<img src="https://www.zhihu.com/equation?tex=X_0" alt="X_0" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=X_1" alt="X_1" class="ee_img tr_noresize" eeimg="1">放在一起讨论，所以需要找个方式表示<img src="https://www.zhihu.com/equation?tex=X_0" alt="X_0" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=X_1" alt="X_1" class="ee_img tr_noresize" eeimg="1">的成对分布：<img src="https://www.zhihu.com/equation?tex=%28X_0%2CX_1%29%5Csim%20p%28X_0%29q%28X_1%29" alt="(X_0,X_1)\sim p(X_0)q(X_1)" class="ee_img tr_noresize" eeimg="1">，就是当成两个独立的RV，用二者的pmf的乘积表示<img src="https://www.zhihu.com/equation?tex=%28X_0%2CX_1%29" alt="(X_0,X_1)" class="ee_img tr_noresize" eeimg="1">的联合分布。也可以用单独的符号<img src="https://www.zhihu.com/equation?tex=%5Cpi_%7B0%2C1%7D%28x_0%2Cx_1%29" alt="\pi_{0,1}(x_0,x_1)" class="ee_img tr_noresize" eeimg="1">表示<img src="https://www.zhihu.com/equation?tex=p%28x_0%29" alt="p(x_0)" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=q%28x_1%29" alt="q(x_1)" class="ee_img tr_noresize" eeimg="1">的联合分布。

举个例子理解，如果对文本生成任务，源分布<img src="https://www.zhihu.com/equation?tex=p%28x_0%29" alt="p(x_0)" class="ee_img tr_noresize" eeimg="1">就是先验分布，一般取：

1.  <img src="https://www.zhihu.com/equation?tex=%5Cmathcal%7BS%7D" alt="\mathcal{S}" class="ee_img tr_noresize" eeimg="1">上的均匀分布

1.  加入一个mask的特殊token <img src="https://www.zhihu.com/equation?tex=%5Cmathtt%7Bm%7D" alt="\mathtt{m}" class="ee_img tr_noresize" eeimg="1">到vocabulary <img src="https://www.zhihu.com/equation?tex=%5Cmathcal%7BT%7D" alt="\mathcal{T}" class="ee_img tr_noresize" eeimg="1">里面，即<img src="https://www.zhihu.com/equation?tex=%5Cmathcal%7BT%7D%5Ccup%20%5C%7B%5Cmathtt%7Bm%7D%5C%7D" alt="\mathcal{T}\cup \{\mathtt{m}\}" class="ee_img tr_noresize" eeimg="1">。

按第2种方法，此时得到<img src="https://www.zhihu.com/equation?tex=%5Cpi_%7B0%2C1%7D%28x_0%2Cx_1%29%3D%5Cdelta%28x_0%2C%5Cmathtt%7Bm%7D%29q%28x_1%29" alt="\pi_{0,1}(x_0,x_1)=\delta(x_0,\mathtt{m})q(x_1)" class="ee_img tr_noresize" eeimg="1">，先验分布就是<img src="https://www.zhihu.com/equation?tex=%5Cdelta%28x_0%2C%5Cmathtt%7Bm%7D%29" alt="\delta(x_0,\mathtt{m})" class="ee_img tr_noresize" eeimg="1">。若<img src="https://www.zhihu.com/equation?tex=X_0%20%5Csim%20%5Cdelta%28X_0%2C%5Cmathtt%7Bm%7D%29" alt="X_0 \sim \delta(X_0,\mathtt{m})" class="ee_img tr_noresize" eeimg="1">，则<img src="https://www.zhihu.com/equation?tex=X_0%3D%28%5Cmathtt%7Bm%7D%2C%5Ccdots%2C%5Cmathtt%7Bm%7D%29" alt="X_0=(\mathtt{m},\cdots,\mathtt{m})" class="ee_img tr_noresize" eeimg="1">。

## 离散概率路径

FM[^2](Lipman)在研究边缘概率路径<img src="https://www.zhihu.com/equation?tex=p_t%28x%29" alt="p_t(x)" class="ee_img tr_noresize" eeimg="1">和生成<img src="https://www.zhihu.com/equation?tex=p_t%28x%29" alt="p_t(x)" class="ee_img tr_noresize" eeimg="1">的边缘向量场时<img src="https://www.zhihu.com/equation?tex=u_t%28x%29" alt="u_t(x)" class="ee_img tr_noresize" eeimg="1">遇到困难（图像在高维空间中造成[^2](Lipman)中的公式6和8的积分不可解，因此没办法得到<img src="https://www.zhihu.com/equation?tex=p_t%28x%29" alt="p_t(x)" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=u_t%28x%29" alt="u_t(x)" class="ee_img tr_noresize" eeimg="1">的解析式），所以转而求解条件向量场<img src="https://www.zhihu.com/equation?tex=u_t%28x%5Cmid%20z%29" alt="u_t(x\mid z)" class="ee_img tr_noresize" eeimg="1">和条件概率路径<img src="https://www.zhihu.com/equation?tex=p_t%28x%5Cmid%20z%29" alt="p_t(x\mid z)" class="ee_img tr_noresize" eeimg="1">。仿照这个办法，DFM也可以按如下方式算边缘概率路径（marginal probability path）：
<img src="https://www.zhihu.com/equation?tex=p_t%28x%29%20%3D%20%5Csum_%7Bz%5Cin%20%5Cmathcal%7BZ%7D%7D%7Bp_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29p_%7BZ%7D%28z%29%7D%5Ctag%7B1%7D" alt="p_t(x) = \sum_{z\in \mathcal{Z}}{p_{t\mid Z}(x\mid z)p_{Z}(z)}\tag{1}" class="ee_img tr_noresize" eeimg="1">
其中<img src="https://www.zhihu.com/equation?tex=Z%5Cin%20%5Cmathcal%7BZ%7D" alt="Z\in \mathcal{Z}" class="ee_img tr_noresize" eeimg="1">是作为条件的随机变量，<img src="https://www.zhihu.com/equation?tex=%5Cmathcal%7BZ%7D" alt="\mathcal{Z}" class="ee_img tr_noresize" eeimg="1">是任意空间。上式是离散版的全概率公式。需要指出的是，**条件概率路径<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29" alt="p_{t\mid Z}(x\mid z)" class="ee_img tr_noresize" eeimg="1">必须满足边界约束<img src="https://www.zhihu.com/equation?tex=p_0%20%3D%20p" alt="p_0 = p" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=p_1%3Dq" alt="p_1=q" class="ee_img tr_noresize" eeimg="1">，**这样才能构建源分布和目标分布之间的关系。

## 边缘化技巧

我们在公式1中已经给出了边缘概率路径<img src="https://www.zhihu.com/equation?tex=p_t%28x%29" alt="p_t(x)" class="ee_img tr_noresize" eeimg="1">和条件概率路径<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29" alt="p_{t\mid Z}(x\mid z)" class="ee_img tr_noresize" eeimg="1">之间的关系，类比在FM里面做的事情，对DFM，我们也想知道条件速度场<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%5Cmid%20z%29" alt="u_t(y,x\mid z)" class="ee_img tr_noresize" eeimg="1">和边缘条件速度场<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29" alt="u_t(y,x)" class="ee_img tr_noresize" eeimg="1">之间的关系。

为了研究这个问题，可以从FM中获得经验。FM中，如果条件向量场<img src="https://www.zhihu.com/equation?tex=u_t%28%5Ccdot%5Cmid%20z%29" alt="u_t(\cdot\mid z)" class="ee_img tr_noresize" eeimg="1">能生成条件概率路径<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28%5Ccdot%5Cmid%20z%29" alt="p_{t\mid Z}(\cdot\mid z)" class="ee_img tr_noresize" eeimg="1">，那边缘向量场<img src="https://www.zhihu.com/equation?tex=u_t%28x%29" alt="u_t(x)" class="ee_img tr_noresize" eeimg="1">满足：
<img src="https://www.zhihu.com/equation?tex=u_t%28x%29%20%3D%20%5Cint%20u_t%28x%5Cmid%20z%29%5Ccfrac%7Bp_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29p_Z%28z%29%7D%7Bp_t%28x%29%7D%5Cmathrm%7Bd%7D%20z%20%3D%5Cint%20u_t%28x%5Cmid%20z%29%20p_%7BZ%5Cmid%20t%7D%28z%5Cmid%20x%29%20%5Cmathrm%7Bd%7Dz%5Ctag%7B2%7D" alt="u_t(x) = \int u_t(x\mid z)\cfrac{p_{t\mid Z}(x\mid z)p_Z(z)}{p_t(x)}\mathrm{d} z =\int u_t(x\mid z) p_{Z\mid t}(z\mid x) \mathrm{d}z\tag{2}" class="ee_img tr_noresize" eeimg="1">
公式2可以参考Flow matching for generative modeling[^2](Lipman)里面的公式8，或者Flow Matching Guide and Code[^1](Lipman)里面的公式4.12。

类比公式2，是否DFM也存在如下关系：当条件速度场<img src="https://www.zhihu.com/equation?tex=u_t%28%5Ccdot%2C%5Ccdot%5Cmid%20z%29" alt="u_t(\cdot,\cdot\mid z)" class="ee_img tr_noresize" eeimg="1">生成条件概率路径<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28%5Ccdot%5Cmid%20z%29" alt="p_{t\mid Z}(\cdot\mid z)" class="ee_img tr_noresize" eeimg="1">时，边缘速度场<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29" alt="u_t(y,x)" class="ee_img tr_noresize" eeimg="1">满足
<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29%20%3D%20%5Csum_z%20u_t%28y%2Cx%20%5Cmid%20z%29%20%5Ccfrac%7Bp_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29p_Z%28z%29%7D%7Bp_t%28x%29%7D%3D%5Csum_z%20u_t%28y%2Cx%5Cmid%20z%29%20p_%7BZ%5Cmid%20t%7D%28z%5Cmid%20x%29%20%5Ctag%7B3%7D" alt="u_t(y,x) = \sum_z u_t(y,x \mid z) \cfrac{p_{t\mid Z}(x\mid z)p_Z(z)}{p_t(x)}=\sum_z u_t(y,x\mid z) p_{Z\mid t}(z\mid x) \tag{3}" class="ee_img tr_noresize" eeimg="1">
答案是肯定的。接下来详细表述和证明这个问题。

---

**假设** <img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29%5Cin%20C%5E%7B1%7D%28%5B0%2C1%29%29" alt="p_{t\mid Z}(x\mid z)\in C^{1}([0,1))" class="ee_img tr_noresize" eeimg="1">。<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%5Cmid%20z%29%5Cin%20C%28%5B0%2C1%29%29" alt="u_t(y,x\mid z)\in C([0,1))" class="ee_img tr_noresize" eeimg="1">。对所有<img src="https://www.zhihu.com/equation?tex=t%5Cin%5B0%2C1%29" alt="t\in[0,1)" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=x%5Cin%20%5Cmathcal%7BS%7D" alt="x\in \mathcal{S}" class="ee_img tr_noresize" eeimg="1">，<img src="https://www.zhihu.com/equation?tex=p_t%28x%29%5Cgt%200" alt="p_t(x)\gt 0" class="ee_img tr_noresize" eeimg="1">。

**定理** （离散边缘化技巧）当上述假设满足时，如果<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%5Cmid%20z%29" alt="u_t(y,x\mid z)" class="ee_img tr_noresize" eeimg="1">生成<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29" alt="p_{t\mid Z}(x\mid z)" class="ee_img tr_noresize" eeimg="1">，那么对<img src="https://www.zhihu.com/equation?tex=t%5Cin%5B0%2C1%29" alt="t\in[0,1)" class="ee_img tr_noresize" eeimg="1">，边缘向量场<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29" alt="u_t(y,x)" class="ee_img tr_noresize" eeimg="1">（公式3）生成边缘概率路径<img src="https://www.zhihu.com/equation?tex=p_t%28x%29" alt="p_t(x)" class="ee_img tr_noresize" eeimg="1">（公式1）。

**证明** 
<img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D%5Ccfrac%7B%5Cmathrm%7Bd%7D%7D%7B%5Cmathrm%7Bd%7Dt%7Dp_t%28y%29%20%26%5Coverset%7B%281%29%7D%7B%3D%7D%20%20%5Ccfrac%7B%5Cmathrm%7Bd%7D%7D%7B%5Cmathrm%7Bd%7Dt%7D%5Cleft%5B%5Csum_z%7Bp_%7Bt%5Cmid%20Z%7D%5Cleft%28y%5Cmid%20z%5Cright%29p_%7BZ%7D%28z%29%7D%5Cright%5D%5C%5C%26%5Coverset%7B%282%29%7D%7B%3D%7D%20%5Csum_z%7B%20%20%20%20%5Ccfrac%7B%5Cmathrm%7Bd%7D%7D%7B%5Cmathrm%7Bd%7Dt%7D%5Cleft%5B%20%20%20%20%09p_%7Bt%5Cmid%20Z%7D%5Cleft%28y%5Cmid%20z%5Cright%29p_%7BZ%7D%28z%29%20%20%20%20%5Cright%5D%7D%5C%5C%26%5Coverset%7B%283%29%7D%7B%3D%7D%20%5Csum_z%7B%20%20%20%20%5Ccfrac%7B%5Cmathrm%7Bd%7D%7D%7B%5Cmathrm%7Bd%7Dt%7D%5Cleft%5B%20%20%20%20%09p_%7Bt%5Cmid%20Z%7D%5Cleft%28y%5Cmid%20z%5Cright%29%20%20%20%20%5Cright%5Dp_%7BZ%7D%28z%29%7D%5C%5C%26%5Coverset%7B%284%29%7D%7B%3D%7D%20%5Csum_z%20%7B%5Csum_x%20%5Cleft%5B%7Bu_t%28y%2Cx%20%5Cmid%20z%29%20p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29%7D%20%5Cright%5D%20p_Z%28z%29%7D%5C%5C%26%5Coverset%7B%285%29%7D%7B%3D%7D%20%5Csum_x%20%7B%5Csum_z%20%5Cleft%5B%7Bu_t%28y%2Cx%20%5Cmid%20z%29%20%5Ccfrac%7Bp_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29p_Z%28z%29%7D%7Bp_t%28x%29%7D%7D%20%5Cright%5D%20p_t%28x%29%7D%5C%5C%26%5Coverset%7B%286%29%7D%7B%3D%7D%20%5Csum_x%20%7B%5Coverbrace%7B%5Csum_z%20%5Cleft%5B%7Bu_t%28y%2Cx%20%5Cmid%20z%29%20p_%7BZ%5Cmid%20t%7D%28z%5Cmid%20x%29%7D%20%5Cright%5D%7D%5E%7Bu_t%28y%2Cx%29%7Dp_t%28x%29%7D%5Cend%7Baligned%7D%5Ctag%7B4%7D" alt="\begin{aligned}\cfrac{\mathrm{d}}{\mathrm{d}t}p_t(y) &\overset{(1)}{=}  \cfrac{\mathrm{d}}{\mathrm{d}t}\left[\sum_z{p_{t\mid Z}\left(y\mid z\right)p_{Z}(z)}\right]\\&\overset{(2)}{=} \sum_z{    \cfrac{\mathrm{d}}{\mathrm{d}t}\left[    	p_{t\mid Z}\left(y\mid z\right)p_{Z}(z)    \right]}\\&\overset{(3)}{=} \sum_z{    \cfrac{\mathrm{d}}{\mathrm{d}t}\left[    	p_{t\mid Z}\left(y\mid z\right)    \right]p_{Z}(z)}\\&\overset{(4)}{=} \sum_z {\sum_x \left[{u_t(y,x \mid z) p_{t\mid Z}(x\mid z)} \right] p_Z(z)}\\&\overset{(5)}{=} \sum_x {\sum_z \left[{u_t(y,x \mid z) \cfrac{p_{t\mid Z}(x\mid z)p_Z(z)}{p_t(x)}} \right] p_t(x)}\\&\overset{(6)}{=} \sum_x {\overbrace{\sum_z \left[{u_t(y,x \mid z) p_{Z\mid t}(z\mid x)} \right]}^{u_t(y,x)}p_t(x)}\end{aligned}\tag{4}" class="ee_img tr_noresize" eeimg="1">

第（4）步是因为根据条件“<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%5Cmid%20z%29" alt="u_t(y,x\mid z)" class="ee_img tr_noresize" eeimg="1">生成<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29" alt="p_{t\mid Z}(x\mid z)" class="ee_img tr_noresize" eeimg="1">”，我们在CTMC模型中讲到的离散质量守恒Discrete Mass Conservation（Discrete Mass Conservation的假设已经满足了，就是上文给出的假设），可知：

-   <img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%5Cmid%20z%29" alt="u_t(y,x\mid z)" class="ee_img tr_noresize" eeimg="1">生成<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29" alt="p_{t\mid Z}(x\mid z)" class="ee_img tr_noresize" eeimg="1">
-   <font color="red"><img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%5Cmid%20z%29" alt="u_t(y,x\mid z)" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D" alt="p_{t\mid Z}" class="ee_img tr_noresize" eeimg="1">满足Kolmogorov方程</font>，且<font color="blue"> <img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%5Cmid%20z%29" alt="u_t(y,x\mid z)" class="ee_img tr_noresize" eeimg="1">满足速率条件（rate conditions）</font>。

二者等价，故直接带入Kolmogorov方程可得第（4）步，只是加了个条件<img src="https://www.zhihu.com/equation?tex=z" alt="z" class="ee_img tr_noresize" eeimg="1">而已。

第（5）是将<img src="https://www.zhihu.com/equation?tex=p_Z%28z%29" alt="p_Z(z)" class="ee_img tr_noresize" eeimg="1">拿到内层求和，并在内层求和的分母上添加一个<img src="https://www.zhihu.com/equation?tex=p_t%28x%29" alt="p_t(x)" class="ee_img tr_noresize" eeimg="1">，此时还需要再乘<img src="https://www.zhihu.com/equation?tex=p_t%28x%29" alt="p_t(x)" class="ee_img tr_noresize" eeimg="1">，可以用分配律把它拿出内层求和。

第（6）步是贝叶斯公式。

最终得出的等式比对一下Kolmogorov方程，可见<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29%3D%5Csum_z%20u_t%28y%2Cx%20%5Cmid%20z%29%20p_%7BZ%5Cmid%20t%7D%28z%5Cmid%20x%29" alt="u_t(y,x)=\sum_z u_t(y,x \mid z) p_{Z\mid t}(z\mid x)" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=p_t" alt="p_t" class="ee_img tr_noresize" eeimg="1">满足Kolmogorov方程。

然后，<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29" alt="u_t(y,x)" class="ee_img tr_noresize" eeimg="1">满足速率条件，因为<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%20%5Cmid%20z%29" alt="u_t(y,x \mid z)" class="ee_img tr_noresize" eeimg="1">满足速率条件，即上文蓝色字的部分。

> 关于为什么<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%20%5Cmid%20z%29" alt="u_t(y,x \mid z)" class="ee_img tr_noresize" eeimg="1">满足速率条件，<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29" alt="u_t(y,x)" class="ee_img tr_noresize" eeimg="1">就满足速率条件的证明：
> 
> 如果<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%20%5Cmid%20z%29" alt="u_t(y,x \mid z)" class="ee_img tr_noresize" eeimg="1">满足速率条件，那么 <img src="https://www.zhihu.com/equation?tex=%5Cforall%20y%5Cneq%20x%20%2C%20u_t%28y%2Cx%5Cmid%20z%29%20%5Cge%200" alt="\forall y\neq x , u_t(y,x\mid z) \ge 0" class="ee_img tr_noresize" eeimg="1">且<img src="https://www.zhihu.com/equation?tex=%5Csum_y%20u_t%28y%2Cx%5Cmid%20z%29%3D0" alt="\sum_y u_t(y,x\mid z)=0" class="ee_img tr_noresize" eeimg="1">
> 
> 根据<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29%3D%5Csum_z%20u_t%28y%2Cx%20%5Cmid%20z%29%20p_%7BZ%5Cmid%20t%7D%28z%5Cmid%20x%29" alt="u_t(y,x)=\sum_z u_t(y,x \mid z) p_{Z\mid t}(z\mid x)" class="ee_img tr_noresize" eeimg="1">，因为<img src="https://www.zhihu.com/equation?tex=p_%7BZ%5Cmid%20t%7D%28z%5Cmid%20x%29" alt="p_{Z\mid t}(z\mid x)" class="ee_img tr_noresize" eeimg="1">显然不小于0，故<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29%20%5Cge%200" alt="u_t(y,x) \ge 0" class="ee_img tr_noresize" eeimg="1">。
> <img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D%5Csum_y%20u_t%28y%2Cx%29%20%26%3D%5Csum_y%5Csum_z%20u_t%28y%2Cx%20%5Cmid%20z%29%20p_%7BZ%5Cmid%20t%7D%28z%5Cmid%20x%29%20%5C%5C%26%3D%5Csum_z%5Csum_y%20u_t%28y%2Cx%20%5Cmid%20z%29%20p_%7BZ%5Cmid%20t%7D%28z%5Cmid%20x%29%20%5C%5C%26%3D%20%5Csum_z%200p_%7BZ%5Cmid%20t%7D%28z%5Cmid%20x%29%20%5C%5C%26%3D%200%5Cend%7Baligned%7D%5Ctag%7B5%7D" alt="\begin{aligned}\sum_y u_t(y,x) &=\sum_y\sum_z u_t(y,x \mid z) p_{Z\mid t}(z\mid x) \\&=\sum_z\sum_y u_t(y,x \mid z) p_{Z\mid t}(z\mid x) \\&= \sum_z 0p_{Z\mid t}(z\mid x) \\&= 0\end{aligned}\tag{5}" class="ee_img tr_noresize" eeimg="1">
> 所以<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29" alt="u_t(y,x)" class="ee_img tr_noresize" eeimg="1">也满足速率条件。


在再次应用Discrete Mass Conservation之前，还得确定一下假设是否满足，因为<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%5Cmid%20z%29%5Cin%20C%28%5B0%2C1%29" alt="u_t(y,x\mid z)\in C([0,1)" class="ee_img tr_noresize" eeimg="1">且<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29%5Cin%20C%5E%7B1%7D%28%5B0%2C1%29%29" alt="p_{t\mid Z}(x\mid z)\in C^{1}([0,1))" class="ee_img tr_noresize" eeimg="1">，故<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29%5Cin%20C%28%5B0%2C1%29%29" alt="u_t(y,x)\in C([0,1))" class="ee_img tr_noresize" eeimg="1">，<img src="https://www.zhihu.com/equation?tex=p_t%28x%29%5Cin%20C%5E1%28%5B0%2C1%29%29" alt="p_t(x)\in C^1([0,1))" class="ee_img tr_noresize" eeimg="1">。

> 关于为什么<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%5Cmid%20z%29%5Cin%20C%28%5B0%2C1%29" alt="u_t(y,x\mid z)\in C([0,1)" class="ee_img tr_noresize" eeimg="1">且<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29%5Cin%20C%5E%7B1%7D%28%5B0%2C1%29%29" alt="p_{t\mid Z}(x\mid z)\in C^{1}([0,1))" class="ee_img tr_noresize" eeimg="1">，就有<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29%5Cin%20C%28%5B0%2C1%29%29" alt="u_t(y,x)\in C([0,1))" class="ee_img tr_noresize" eeimg="1">。我自己的理解如下：
> 
> 因为<img src="https://www.zhihu.com/equation?tex=p_t%28x%29%20%3D%20%5Csum_%7Bz%7D%7Bp_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29p_%7BZ%7D%28z%29%7D" alt="p_t(x) = \sum_{z}{p_{t\mid Z}(x\mid z)p_{Z}(z)}" class="ee_img tr_noresize" eeimg="1">，<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29" alt="p_{t\mid Z}(x\mid z)" class="ee_img tr_noresize" eeimg="1">在<img src="https://www.zhihu.com/equation?tex=t%5Cin%5B0%2C1%29" alt="t\in[0,1)" class="ee_img tr_noresize" eeimg="1">上连续，<img src="https://www.zhihu.com/equation?tex=p_Z%28z%29" alt="p_Z(z)" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=t" alt="t" class="ee_img tr_noresize" eeimg="1">无关，所以<img src="https://www.zhihu.com/equation?tex=p_t%28x%29" alt="p_t(x)" class="ee_img tr_noresize" eeimg="1">在<img src="https://www.zhihu.com/equation?tex=t%5Cin%5B0%2C1%29" alt="t\in[0,1)" class="ee_img tr_noresize" eeimg="1">连续。<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29" alt="p_{t\mid Z}(x\mid z)" class="ee_img tr_noresize" eeimg="1">的一阶导在<img src="https://www.zhihu.com/equation?tex=t%5Cin%5B0%2C1%29" alt="t\in[0,1)" class="ee_img tr_noresize" eeimg="1">上连续，<img src="https://www.zhihu.com/equation?tex=p_Z%28z%29" alt="p_Z(z)" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=t" alt="t" class="ee_img tr_noresize" eeimg="1">无关，<img src="https://www.zhihu.com/equation?tex=%5Cdot%20p_t%28x%29%20%3D%20%5Csum_%7Bz%7D%7B%5Cdot%20p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29p_%7BZ%7D%28z%29%7D" alt="\dot p_t(x) = \sum_{z}{\dot p_{t\mid Z}(x\mid z)p_{Z}(z)}" class="ee_img tr_noresize" eeimg="1">，故<img src="https://www.zhihu.com/equation?tex=%5Cdot%20p_t%28x%29" alt="\dot p_t(x)" class="ee_img tr_noresize" eeimg="1">也在<img src="https://www.zhihu.com/equation?tex=t%5Cin%5B0%2C1%29" alt="t\in[0,1)" class="ee_img tr_noresize" eeimg="1">上连续。
> 
> 因为<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29%3D%5Csum_z%20u_t%28y%2Cx%20%5Cmid%20z%29%20p_%7BZ%5Cmid%20t%7D%28z%5Cmid%20x%29%3D%20%5Csum_z%20u_t%28y%2Cx%20%5Cmid%20z%29%20%5Ccfrac%7Bp_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29p_Z%28z%29%7D%7Bp_t%28x%29%7D" alt="u_t(y,x)=\sum_z u_t(y,x \mid z) p_{Z\mid t}(z\mid x)= \sum_z u_t(y,x \mid z) \cfrac{p_{t\mid Z}(x\mid z)p_Z(z)}{p_t(x)}" class="ee_img tr_noresize" eeimg="1">，在<img src="https://www.zhihu.com/equation?tex=t%5Cin%5B0%2C1%29" alt="t\in[0,1)" class="ee_img tr_noresize" eeimg="1">时，<img src="https://www.zhihu.com/equation?tex=p_%7Bt%5Cmid%20Z%7D%28x%5Cmid%20z%29" alt="p_{t\mid Z}(x\mid z)" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%5Cmid%20z%29" alt="u_t(y,x\mid z)" class="ee_img tr_noresize" eeimg="1">都连续，<img src="https://www.zhihu.com/equation?tex=p_Z%28z%29" alt="p_Z(z)" class="ee_img tr_noresize" eeimg="1">和<img src="https://www.zhihu.com/equation?tex=t" alt="t" class="ee_img tr_noresize" eeimg="1">无关，根据假设<img src="https://www.zhihu.com/equation?tex=p_t%28x%29%5Cgt0" alt="p_t(x)\gt0" class="ee_img tr_noresize" eeimg="1">，同时<img src="https://www.zhihu.com/equation?tex=p_t%28x%29" alt="p_t(x)" class="ee_img tr_noresize" eeimg="1">在<img src="https://www.zhihu.com/equation?tex=t%5Cin%5B0%2C1%29" alt="t\in[0,1)" class="ee_img tr_noresize" eeimg="1">连续，所以<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29" alt="u_t(y,x)" class="ee_img tr_noresize" eeimg="1">在<img src="https://www.zhihu.com/equation?tex=t%5Cin%5B0%2C1%29" alt="t\in[0,1)" class="ee_img tr_noresize" eeimg="1">连续。从这里能看到假设为什么一定要<img src="https://www.zhihu.com/equation?tex=p_t%28x%29%5Cgt0" alt="p_t(x)\gt0" class="ee_img tr_noresize" eeimg="1">。
> 
> 从上面这些解释就知道<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29%5Cin%20C%28%5B0%2C1%29%29" alt="u_t(y,x)\in C([0,1))" class="ee_img tr_noresize" eeimg="1">，<img src="https://www.zhihu.com/equation?tex=p_t%28x%29%20%5Cin%20C%5E1%28%5B0%2C1%29" alt="p_t(x) \in C^1([0,1)" class="ee_img tr_noresize" eeimg="1">。


所以假设也满足，可以应用Discrete Mass Conservation，得到**<img src="https://www.zhihu.com/equation?tex=u_t%28y%2Cx%29" alt="u_t(y,x)" class="ee_img tr_noresize" eeimg="1">生成<img src="https://www.zhihu.com/equation?tex=p_%7Bt%7D%28x%29" alt="p_{t}(x)" class="ee_img tr_noresize" eeimg="1">**。证明完毕。

**补充** 关于<img src="https://www.zhihu.com/equation?tex=t%5Cin%5B0%2C1%29" alt="t\in[0,1)" class="ee_img tr_noresize" eeimg="1">时，<img src="https://www.zhihu.com/equation?tex=p_t%5Cgt0" alt="p_t\gt0" class="ee_img tr_noresize" eeimg="1">的假设是可以满足的。因为我们可以使用<img src="https://www.zhihu.com/equation?tex=%281-%281-t%29%5Cepsilon%29%20%5Ccdot%20p_%7BZ%5Cmid%20t%7D%20%2B%20%281%20-%20t%29%5Cepsilon%20%5Ccdot%20p_%7B%5Ctext%7Buni%7D%7D" alt="(1-(1-t)\epsilon) \cdot p_{Z\mid t} + (1 - t)\epsilon \cdot p_{\text{uni}}" class="ee_img tr_noresize" eeimg="1">，其中<img src="https://www.zhihu.com/equation?tex=p_%7B%5Ctext%7Buni%7D%7D" alt="p_{\text{uni}}" class="ee_img tr_noresize" eeimg="1">是均匀分布，<img src="https://www.zhihu.com/equation?tex=%5Cepsilon" alt="\epsilon" class="ee_img tr_noresize" eeimg="1">是大于0的很小的值。我的理解就是通过稍微加入一点服从均匀分布的噪声，让<img src="https://www.zhihu.com/equation?tex=%5B0%2C1%29" alt="[0,1)" class="ee_img tr_noresize" eeimg="1">上，<img src="https://www.zhihu.com/equation?tex=p_t" alt="p_t" class="ee_img tr_noresize" eeimg="1">都有概率。

---

## DFM损失

像FM里面一样，我们可以用一个神经网络来学习速度场<img src="https://www.zhihu.com/equation?tex=u_%7Bt%7D%5E%7B%5Ctheta%7D%28y%2Cx%29" alt="u_{t}^{\theta}(y,x)" class="ee_img tr_noresize" eeimg="1">，其中<img src="https://www.zhihu.com/equation?tex=%5Ctheta" alt="\theta" class="ee_img tr_noresize" eeimg="1">是可学习的参数。类比FM，可以构建DFM的损失：
<img src="https://www.zhihu.com/equation?tex=L_%7BDFM%7D%28%5Ctheta%29%20%3D%20%5Cmathbb%7BE%7D_%7Bt%2CX_t%5Csim%20p_t%7DD_%7BX_t%7D%5Cbig%28u_t%28%5Ccdot%2CX_t%29%2Cu_t%5E%7B%5Ctheta%7D%28%5Ccdot%2CX_t%29%5Cbig%29%20%5Ctag%7B6%7D" alt="L_{DFM}(\theta) = \mathbb{E}_{t,X_t\sim p_t}D_{X_t}\big(u_t(\cdot,X_t),u_t^{\theta}(\cdot,X_t)\big) \tag{6}" class="ee_img tr_noresize" eeimg="1">

这里，$t\sim U[0,1]<img src="https://www.zhihu.com/equation?tex=%EF%BC%8C" alt="，" class="ee_img tr_noresize" eeimg="1">u_t(\cdot,x)\in R^{\mathcal{S}}<img src="https://www.zhihu.com/equation?tex=%E6%BB%A1%E8%B6%B3%E9%80%9F%E7%8E%87%E6%9D%A1%E4%BB%B6%E3%80%82%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%EF%BC%8C" alt="满足速率条件。也就是说，" class="ee_img tr_noresize" eeimg="1">u_t(\cdot,x)\in \Omega_x<img src="https://www.zhihu.com/equation?tex=%EF%BC%8C%E4%B8%94%EF%BC%9A" alt="，且：" class="ee_img tr_noresize" eeimg="1">$
\Omega_x = \left\{
v \in R^{\mathcal{S}} \mid v(y) > 0 \text{ }\forall y \neq x,\text{ and } v(x) = - \sum_{y\neq x} v(y)  
\right\} \in R^{\mathcal{S}} \tag{7}
$<img src="https://www.zhihu.com/equation?tex=" alt="" class="ee_img tr_noresize" eeimg="1">\Omega_x<img src="https://www.zhihu.com/equation?tex=%E6%98%AF%E5%87%B8%E9%9B%86%E5%90%88%E3%80%82" alt="是凸集合。" class="ee_img tr_noresize" eeimg="1">D_{X_t}(u,v)<img src="https://www.zhihu.com/equation?tex=%E6%98%AFBregman%E6%95%A3%E5%BA%A6%EF%BC%8C%E5%85%B6%E4%BD%BF%E7%94%A8%E5%87%B8%E5%87%BD%E6%95%B0" alt="是Bregman散度，其使用凸函数" class="ee_img tr_noresize" eeimg="1">\Phi_x : \Omega_x \to \mathbb{R}$定义。

---

Bregman的具体计算方式如下图和下式所示：

![image-20250105124855569](https://cdn.jsdelivr.net/gh/Ly403/blogs@_md2zhihu_blogs_f77d54f0/dfm/c133a8c349f9a144-image-20250105124855569.png)
<img src="https://www.zhihu.com/equation?tex=%5Cdisplaystyle%20D%28%20u%2Cv%29%20%5C%20%3A%3D%5C%20%5CPhi%20%28%20u%29%20%5C%20-%5C%20%5B%20%5CPhi%20%28%20v%29%20%5C%20%2B%5C%20%5Clangle%20u-v%2C%5Cnabla%20%5CPhi%20%28%20v%29%20%5Crangle%20%5D%20%5Ctag%7B8%7D" alt="\displaystyle D( u,v) \ :=\ \Phi ( u) \ -\ [ \Phi ( v) \ +\ \langle u-v,\nabla \Phi ( v) \rangle ] \tag{8}" class="ee_img tr_noresize" eeimg="1">
Bregman散度有一些关键的性质，在FM和DFM里面最关键的是它对第二个参数的梯度有仿射不变性（affine invariant）[^3](Holderrieth)：
<img src="https://www.zhihu.com/equation?tex=%5Cnabla_v%20D%28au_1%20%2B%20b_u2%2C%20v%29%20%3D%20a%5Cnabla_v%20D%28u_1%2Cv%29%20%2Bb%5Cnabla_vD%28u_2%2Cv%29%2C%20%5Ctext%7B%20for%20any%20%7D%20a%2Bb%3D1%20%5Ctag%7B9%7D" alt="\nabla_v D(au_1 + b_u2, v) = a\nabla_v D(u_1,v) +b\nabla_vD(u_2,v), \text{ for any } a+b=1 \tag{9}" class="ee_img tr_noresize" eeimg="1">
因为仿射不变性，可以得到$\nabla_vD(\mathbb{E}[Y] ,v) =\mathbb{E}[\nabla_v D(Y,v)]$。

关于Bregman散度的详细信息，在知乎上已经有很好的回答了，可以参考：https://www.zhihu.com/question/22426561。

---

就像在FM里面一样，我们更关注条件DFM（Conditional Discrete Flow Matching，CDFM）的损失函数形式，因为我们想仿照FM里面一样用神经网络预测条件速度场，如Flow matching for generative modeling[^2](Lipman)里面的公式9所示。那么CDFM的损失就是：
<img src="https://www.zhihu.com/equation?tex=L_%7BCDFM%7D%28%5Ctheta%29%20%3D%20%5Cmathbb%7BE%7D_%7Bt%2CZ%2CX_t%5Csim%20p_%7Bt%5Cmid%20Z%7D%7DD_%7BX_t%7D%5Cbig%28u_t%28%5Ccdot%2CX_t%20%5Cmid%20Z%29%2Cu_t%5E%7B%5Ctheta%7D%28%5Ccdot%2CX_t%29%5Cbig%29%20%5Ctag%7B10%7D" alt="L_{CDFM}(\theta) = \mathbb{E}_{t,Z,X_t\sim p_{t\mid Z}}D_{X_t}\big(u_t(\cdot,X_t \mid Z),u_t^{\theta}(\cdot,X_t)\big) \tag{10}" class="ee_img tr_noresize" eeimg="1">
<img src="https://www.zhihu.com/equation?tex=u_t%28%5Ccdot%2CX_t%20%5Cmid%20Z%29" alt="u_t(\cdot,X_t \mid Z)" class="ee_img tr_noresize" eeimg="1">是目标条件速度场，<img src="https://www.zhihu.com/equation?tex=u_t%5E%7B%5Ctheta%7D%28%5Ccdot%2CX_t%29" alt="u_t^{\theta}(\cdot,X_t)" class="ee_img tr_noresize" eeimg="1">是模型学习的条件速度场。

像FM里面一样，我们也能说明公式6和公式10的梯度一样：

**定理** DFM和CDFM损失的梯度相同：
<img src="https://www.zhihu.com/equation?tex=%5Cnabla_%5Ctheta%20L_%7BDFM%7D%28%5Ctheta%29%20%3D%5Cnabla_%5Ctheta%20L_%7BCDFM%7D%28%5Ctheta%29%20%5Ctag%7B11%7D" alt="\nabla_\theta L_{DFM}(\theta) =\nabla_\theta L_{CDFM}(\theta) \tag{11}" class="ee_img tr_noresize" eeimg="1">
使得CDFM损失最小的<img src="https://www.zhihu.com/equation?tex=u%5E%7B%5Ctheta%7D_t%28y%2C%20X_t%29" alt="u^{\theta}_t(y, X_t)" class="ee_img tr_noresize" eeimg="1">是：
<img src="https://www.zhihu.com/equation?tex=u%5E%7B%5Ctheta%7D_t%28y%2CX_t%29%20%3D%20%5Cmathbb%7BE%7D%20%5Cleft%5Bu_t%28y%2CX_t%20%5Cmid%20Z%29%20%5Cmid%20X_t%20%3Dx%5Cright%5D%20%5Ctag%7B12%7D" alt="u^{\theta}_t(y,X_t) = \mathbb{E} \left[u_t(y,X_t \mid Z) \mid X_t =x\right] \tag{12}" class="ee_img tr_noresize" eeimg="1">

---

我参照[^1](Lipman)以及一些自己的理解给了**证明**。

先看公式11的证明：
<img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D%5Cnabla_%5Ctheta%20L_%7BDFM%7D%28%5Ctheta%29%20%26%3D%20%5Cnabla_%5Ctheta%20%20%20%5Cmathbb%7BE%7D_%7Bt%2CX_t%5Csim%20p_t%7D%5Cleft%5BD_%7BX_t%7D%5Cbig%28u_t%28y%2CX_t%29%2Cu_t%5E%7B%5Ctheta%7D%28y%2CX_t%29%5Cbig%29%5Cright%5D%20%5C%5C%26%3D%20%5Cmathbb%7BE%7D_%7Bt%2CX_t%5Csim%20p_t%7D%20%5Cleft%5B%5Cnabla_%5Ctheta%20D_%7BX_t%7D%5Cbig%28u_t%28y%2CX_t%29%2Cu_t%5E%7B%5Ctheta%7D%28y%2CX_t%29%5Cbig%29%20%5Cright%5D%5C%5C%26%3D%20%5Cmathbb%7BE%7D_%7Bt%2CX_t%5Csim%20p_t%7D%20%5Cleft%5B%5Cnabla_%7Bu%5E%7B%5Ctheta%7D_t%28y%2CX_t%29%7D%20D_%7BX_t%7D%5Cbig%28u_t%28y%2CX_t%29%2Cu_t%5E%7B%5Ctheta%7D%28y%2CX_t%29%5Cbig%29%5Cnabla_%7B%5Ctheta%7Du%5E%7B%5Ctheta%7D_t%28y%2CX_t%29%20%5Cright%5D%5C%5C%26%3D%5Cmathbb%7BE%7D_%7Bt%2CX_t%5Csim%20p_t%7D%20%5Cleft%5B%5Cnabla_%7Bu%5E%7B%5Ctheta%7D_t%28y%2CX_t%29%7D%20D_%7BX_t%7D%5Cbig%28%5Csum_Z%20u_t%28y%2CX_t%20%5Cmid%20Z%29%20p_%7BZ%5Cmid%20t%7D%28Z%5Cmid%20X_t%29%2Cu_t%5E%7B%5Ctheta%7D%28y%2CX_t%29%5Cbig%29%5Cnabla_%7B%5Ctheta%7Du%5E%7B%5Ctheta%7D_t%28y%2CX_t%29%20%5Cright%5D%20%5C%5C%26%3D%5Cmathbb%7BE%7D_%7Bt%2CX_t%5Csim%20p_t%7D%20%5Cleft%5B%5Cnabla_%7Bu%5E%7B%5Ctheta%7D_t%28y%2CX_t%29%7D%20D_%7BX_t%7D%5Cleft%28%5Cmathbb%7BE%7D_%7BZ%5Csim%20%20p_%7BZ%5Cmid%20t%7D%28Z%5Cmid%20X_t%29%7D%20%5Cleft%5Bu_t%28y%2CX_t%20%5Cmid%20Z%29%5Cright%5D%2Cu_t%5E%7B%5Ctheta%7D%28y%2CX_t%29%5Cright%29%5Cnabla_%7B%5Ctheta%7Du%5E%7B%5Ctheta%7D_t%28y%2CX_t%29%20%5Cright%5D%20%5C%5C%26%3D%5Cmathbb%7BE%7D_%7Bt%2CX_t%5Csim%20p_t%7D%20%5Cleft%5B%5Cnabla_%7Bu%5E%7B%5Ctheta%7D_t%28y%2CX_t%29%7D%20%5Cmathbb%7BE%7D_%7BZ%5Csim%20%20p_%7BZ%5Cmid%20t%7D%28Z%5Cmid%20X_t%29%7D%20%20%5Cleft%5B%20D_%7BX_t%7D%5Cleft%28u_t%28y%2CX_t%20%5Cmid%20Z%29%2Cu_t%5E%7B%5Ctheta%7D%28y%2CX_t%29%5Cright%29%5Cnabla_%7B%5Ctheta%7Du%5E%7B%5Ctheta%7D_t%28y%2CX_t%29%5Cright%5D%20%5Cright%5D%20%5C%5C%26%3D%5Cmathbb%7BE%7D_%7Bt%2CX_t%5Csim%20p_t%7D%20%5Cleft%5B%5Cmathbb%7BE%7D_%7BZ%5Csim%20%20p_%7BZ%5Cmid%20t%7D%28Z%5Cmid%20X_t%29%7D%20%20%5Cleft%5B%5Cnabla_%7Bu%5E%7B%5Ctheta%7D_t%28y%2CX_t%29%7D%20D_%7BX_t%7D%5Cleft%28u_t%28y%2CX_t%20%5Cmid%20Z%29%2Cu_t%5E%7B%5Ctheta%7D%28y%2CX_t%29%5Cright%29%5Cnabla_%7B%5Ctheta%7Du%5E%7B%5Ctheta%7D_t%28y%2CX_t%29%5Cright%5D%20%5Cright%5D%20%5C%5C%26%3D%5Cmathbb%7BE%7D_%7Bt%2CX_t%5Csim%20p_t%7D%20%5Cleft%5B%5Cmathbb%7BE%7D_%7BZ%5Csim%20%20p_%7BZ%5Cmid%20t%7D%28Z%5Cmid%20X_t%29%7D%20%20%5Cleft%5B%5Cnabla_%7B%5Ctheta%7D%20D_%7BX_t%7D%5Cleft%28u_t%28y%2CX_t%20%5Cmid%20Z%29%2Cu_t%5E%7B%5Ctheta%7D%28y%2CX_t%29%5Cright%29%5Cright%5D%20%5Cright%5D%20%5C%5C%26%3D%5Cnabla_%7B%5Ctheta%7D%20%5Cmathbb%7BE%7D_%7Bt%2CX_t%5Csim%20p_t%7D%20%5Cleft%5B%5Cmathbb%7BE%7D_%7BZ%5Csim%20%20p_%7BZ%5Cmid%20t%7D%28Z%5Cmid%20X_t%29%7D%20%20%5Cleft%5BD_%7BX_t%7D%5Cleft%28u_t%28y%2CX_t%20%5Cmid%20Z%29%2Cu_t%5E%7B%5Ctheta%7D%28y%2CX_t%29%5Cright%29%5Cright%5D%20%5Cright%5D%20%5C%5C%26%3D%5Cnabla_%7B%5Ctheta%7D%5Cmathbb%7BE%7D_%7Bt%2CX_t%5Csim%20p_%7Bt%5Cmid%20Z%7D%28X_t%20%5Cmid%20Z%29%2CZ%5Csim%20q%28Z%29%7D%20%20%5Cleft%5B%20D_%7BX_t%7D%5Cleft%28u_t%28y%2CX_t%20%5Cmid%20Z%29%2Cu_t%5E%7B%5Ctheta%7D%28y%2CX_t%29%5Cright%29%5Cright%5D%20%5C%5C%26%3D%20%5Cnabla_%7B%5Ctheta%7D%20L_%7BCDFM%7D%28%5Ctheta%29%5Cend%7Baligned%7D%5Ctag%7B13%7D" alt="\begin{aligned}\nabla_\theta L_{DFM}(\theta) &= \nabla_\theta   \mathbb{E}_{t,X_t\sim p_t}\left[D_{X_t}\big(u_t(y,X_t),u_t^{\theta}(y,X_t)\big)\right] \\&= \mathbb{E}_{t,X_t\sim p_t} \left[\nabla_\theta D_{X_t}\big(u_t(y,X_t),u_t^{\theta}(y,X_t)\big) \right]\\&= \mathbb{E}_{t,X_t\sim p_t} \left[\nabla_{u^{\theta}_t(y,X_t)} D_{X_t}\big(u_t(y,X_t),u_t^{\theta}(y,X_t)\big)\nabla_{\theta}u^{\theta}_t(y,X_t) \right]\\&=\mathbb{E}_{t,X_t\sim p_t} \left[\nabla_{u^{\theta}_t(y,X_t)} D_{X_t}\big(\sum_Z u_t(y,X_t \mid Z) p_{Z\mid t}(Z\mid X_t),u_t^{\theta}(y,X_t)\big)\nabla_{\theta}u^{\theta}_t(y,X_t) \right] \\&=\mathbb{E}_{t,X_t\sim p_t} \left[\nabla_{u^{\theta}_t(y,X_t)} D_{X_t}\left(\mathbb{E}_{Z\sim  p_{Z\mid t}(Z\mid X_t)} \left[u_t(y,X_t \mid Z)\right],u_t^{\theta}(y,X_t)\right)\nabla_{\theta}u^{\theta}_t(y,X_t) \right] \\&=\mathbb{E}_{t,X_t\sim p_t} \left[\nabla_{u^{\theta}_t(y,X_t)} \mathbb{E}_{Z\sim  p_{Z\mid t}(Z\mid X_t)}  \left[ D_{X_t}\left(u_t(y,X_t \mid Z),u_t^{\theta}(y,X_t)\right)\nabla_{\theta}u^{\theta}_t(y,X_t)\right] \right] \\&=\mathbb{E}_{t,X_t\sim p_t} \left[\mathbb{E}_{Z\sim  p_{Z\mid t}(Z\mid X_t)}  \left[\nabla_{u^{\theta}_t(y,X_t)} D_{X_t}\left(u_t(y,X_t \mid Z),u_t^{\theta}(y,X_t)\right)\nabla_{\theta}u^{\theta}_t(y,X_t)\right] \right] \\&=\mathbb{E}_{t,X_t\sim p_t} \left[\mathbb{E}_{Z\sim  p_{Z\mid t}(Z\mid X_t)}  \left[\nabla_{\theta} D_{X_t}\left(u_t(y,X_t \mid Z),u_t^{\theta}(y,X_t)\right)\right] \right] \\&=\nabla_{\theta} \mathbb{E}_{t,X_t\sim p_t} \left[\mathbb{E}_{Z\sim  p_{Z\mid t}(Z\mid X_t)}  \left[D_{X_t}\left(u_t(y,X_t \mid Z),u_t^{\theta}(y,X_t)\right)\right] \right] \\&=\nabla_{\theta}\mathbb{E}_{t,X_t\sim p_{t\mid Z}(X_t \mid Z),Z\sim q(Z)}  \left[ D_{X_t}\left(u_t(y,X_t \mid Z),u_t^{\theta}(y,X_t)\right)\right] \\&= \nabla_{\theta} L_{CDFM}(\theta)\end{aligned}\tag{13}" class="ee_img tr_noresize" eeimg="1">
再看公式12的证明：

代入公式12到<img src="https://www.zhihu.com/equation?tex=L_%7BCDFM%7D%28%5Ctheta%29" alt="L_{CDFM}(\theta)" class="ee_img tr_noresize" eeimg="1">中，得到
<img src="https://www.zhihu.com/equation?tex=L_%7BCDFM%7D%28%5Ctheta%29%20%3D%20%5Cmathbb%7BE%7D_%7Bt%2CZ%2CX_t%5Csim%20p_%7Bt%5Cmid%20Z%7D%7DD_%7BX_t%7D%5CBig%28u_t%28y%2CX_t%20%5Cmid%20Z%29%2C%20%5Cmathbb%7BE%7D%20%5Cleft%5Bu_t%28y%2CX_t%20%5Cmid%20Z%29%20%5Cmid%20X_t%20%3Dx%5Cright%5D%5CBig%29%20%5Ctag%7B14%7D" alt="L_{CDFM}(\theta) = \mathbb{E}_{t,Z,X_t\sim p_{t\mid Z}}D_{X_t}\Big(u_t(y,X_t \mid Z), \mathbb{E} \left[u_t(y,X_t \mid Z) \mid X_t =x\right]\Big) \tag{14}" class="ee_img tr_noresize" eeimg="1">
按照Bregman散度的定义，可知<img src="https://www.zhihu.com/equation?tex=L_%7BCDFM%7D%28%5Ctheta%29%20%3D0" alt="L_{CDFM}(\theta) =0" class="ee_img tr_noresize" eeimg="1">，是一个全局最小值。所以使得<img src="https://www.zhihu.com/equation?tex=L_%7BCDFM%7D%28%5Ctheta%29" alt="L_{CDFM}(\theta)" class="ee_img tr_noresize" eeimg="1">最小的<img src="https://www.zhihu.com/equation?tex=u%5E%7B%5Ctheta%7D_t" alt="u^{\theta}_t" class="ee_img tr_noresize" eeimg="1">满足公式12。

在Flow Matching Guide and Code[^1](Lipman)21页最上面（公式4.25和4.26）还有一个更一般化的证明。

---

这一节先到这里吧。

---



Reference:

- Y, Havasi M, Holderrieth P, et al. Flow Matching Guide and Code[J]. arXiv preprint arXiv:2412.06264, 2024. : [Lipman](Lipman)

- Y, Chen R T Q, Ben-Hamu H, et al. Flow matching for generative modeling[J]. arXiv preprint arXiv:2210.02747, 2022. : [Lipman](Lipman)

- P, Havasi M, Yim J, et al. Generator Matching: Generative modeling with arbitrary Markov processes[J]. arXiv preprint arXiv:2410.20587, 2024. : [Holderrieth](Holderrieth)


[^1]:  Lipman Y, Havasi M, Holderrieth P, et al. Flow Matching Guide and Code[J]. arXiv preprint arXiv:2412.06264, 2024.
[^2]:  Lipman Y, Chen R T Q, Ben-Hamu H, et al. Flow matching for generative modeling[J]. arXiv preprint arXiv:2210.02747, 2022.
[^3]:  Holderrieth P, Havasi M, Yim J, et al. Generator Matching: Generative modeling with arbitrary Markov processes[J]. arXiv preprint arXiv:2410.20587, 2024.